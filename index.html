<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spice Jar</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #2b0a3d 0%, #4a1c40 100%);
            --card-bg: #1e1b2e;
            --primary: #ff4757;
            --secondary: #2ed573;
            --accent: #ffa502;
            --text-main: #ffffff;
            --text-muted: #a4b0be;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
            --glass: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-gradient);
            font-family: 'Quicksand', sans-serif;
            color: var(--text-main);
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .app-frame {
            width: 100%; height: 100%;
            max-width: 420px;
            background: rgba(0,0,0,0.2);
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* Views */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            padding: 2rem;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0.95);
            backdrop-filter: blur(5px);
            z-index: 1;
        }
        
        .view.active {
            opacity: 1; pointer-events: auto;
            transform: scale(1);
            z-index: 10;
        }

        h1 { font-size: 3rem; margin: 0; background: -webkit-linear-gradient(0deg, #ff4757, #ffa502); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        h2 { font-size: 1.8rem; margin-bottom: 1rem; text-align: center; }
        p { text-align: center; color: var(--text-muted); line-height: 1.5; }

        .input-glass {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.2);
            padding: 15px; border-radius: 12px; color: white; width: 100%;
            margin-bottom: 15px; font-size: 1rem; outline: none; text-align: center;
            transition: 0.3s;
        }
        .input-glass:focus { border-color: var(--primary); background: rgba(255,255,255,0.15); }

        .btn-gamified {
            background: linear-gradient(90deg, #ff4757, #ff6b81);
            color: white; border: none; padding: 16px; width: 100%;
            border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s; margin-top: 10px;
        }
        .btn-gamified:active { transform: scale(0.96); }
        .btn-secondary { background: transparent; border: 2px solid rgba(255,255,255,0.2); box-shadow: none; }

        /* DECK AREA */
        .deck-container {
            width: 100%; height: 400px; position: relative;
            margin: 20px 0; perspective: 1000px;
            /* Important for dragging */
            touch-action: none; 
        }
        
        .card {
            width: 100%; height: 100%;
            background: var(--card-bg);
            border-radius: 20px;
            position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 30px; text-align: center;
            font-size: 1.8rem; font-weight: 700;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.1);
            /* Transformation handled by JS during drag, CSS during release */
            transform-origin: 50% 100%;
            will-change: transform;
            cursor: grab;
        }
        
        .card:active { cursor: grabbing; }

        /* Overlay indicators (Like/Nope) */
        .card::after {
            content: ''; position: absolute; top: 20px; right: 20px;
            font-size: 2rem; opacity: 0; font-weight: bold;
            border: 4px solid; border-radius: 10px; padding: 5px 10px; transform: rotate(15deg);
        }

        /* Animations */
        .animate-yes { animation: flyOutRight 0.5s forwards; }
        .animate-no { animation: flyOutLeft 0.5s forwards; }
        .reset-anim { transition: transform 0.3s ease; }

        @keyframes flyOutRight { to { transform: translateX(150%) rotate(25deg); opacity: 0; } }
        @keyframes flyOutLeft { to { transform: translateX(-150%) rotate(-25deg); opacity: 0; } }

        .game-controls { display: flex; gap: 30px; width: 100%; justify-content: center; z-index: 20; }
        .control-btn {
            width: 70px; height: 70px; border-radius: 50%; border: none;
            font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn-no { background: #2f3542; color: #ff4757; }
        .btn-yes { background: white; color: #2ed573; }
        .control-btn:active { transform: scale(0.9); }

        .progress-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; }

        .jar-glow { font-size: 6rem; filter: drop-shadow(0 0 20px rgba(255, 165, 2, 0.6)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .result-card {
            background: white; color: #2b0a3d; padding: 2rem;
            border-radius: 20px; width: 100%; text-align: center;
            font-size: 1.5rem; font-weight: bold;
            transform: scale(0); animation: popIn 0.5s forwards 0.2s;
        }
        @keyframes popIn { to { transform: scale(1); } }

        #confetti { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>

<div class="app-frame">
    <canvas id="confetti"></canvas>

    <div id="landing" class="view active">
        <div style="font-size: 4rem; margin-bottom:10px;">üå∂Ô∏è</div>
        <h1>Spice Jar</h1>
        <p>Swipe. Match. Play.</p>
        <div style="margin-top: 30px; width: 100%;">
            <button class="btn-gamified" onclick="navTo('auth')">Enter</button>
        </div>
    </div>

    <div id="auth" class="view">
        <h2>Identity</h2>
        <input type="text" id="username" class="input-glass" placeholder="Your Nickname">
        <input type="text" id="groupName" class="input-glass" placeholder="Secret Room Code">
        <button class="btn-gamified" onclick="handleLogin()">Join Room</button>
        <p style="font-size: 0.8rem; margin-top: 10px;">Share the code with your partner.</p>
    </div>

    <div id="dashboard" class="view">
        <h2>Lobby</h2>
        <div id="status-area" style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; width: 100%; text-align: center; margin-bottom: 20px;"></div>
        <button class="btn-gamified" id="start-btn" onclick="startGame()">Start Swiping</button>
        <button class="btn-gamified btn-secondary" onclick="logout()">Leave</button>
    </div>

    <div id="selection" class="view">
        <div class="progress-container"><div class="progress-fill" id="progress"></div></div>
        
        <div class="deck-container" id="deck">
            <div class="card" id="active-card">
                <div>Drag Me!</div>
                <div style="font-size:0.8rem; opacity:0.6; margin-top:10px;">(Left = No, Right = Yes)</div>
            </div>
        </div>

        <div class="game-controls">
            <button class="control-btn btn-no" onclick="handleButtonSwipe(false)">‚úñ</button>
            <button class="control-btn btn-yes" onclick="handleButtonSwipe(true)">‚ô•</button>
        </div>
    </div>

    <div id="bucket" class="view">
        <div class="jar-glow">üçØ</div>
        <h2>It's a Match!</h2>
        <p>Matches found: <span id="match-count" style="color: var(--accent); font-weight:bold;">0</span></p>
        <div id="result-wrapper" style="width: 100%; margin: 20px 0; min-height: 100px; display: flex; align-items: center; justify-content: center;"></div>
        <button class="btn-gamified" onclick="pullRandom()">Open Jar</button>
        <button class="btn-gamified btn-secondary" onclick="resetGroup()">Reset</button>
    </div>
</div>

<script>
    // --- DATA ---
    const CARDS = [
        "Sensual Massage", "Roleplay Strangers", "Cook Naked", 
        "Truth or Dare", "Blindfolds", "Shower Together", 
        "Gentle Bondage", "Strip Poker", "Watch 50 Shades", 
        "Quickie", "Full Body Paint", "Whisper Fantasies", "No Phones Night"
    ];

    let currentUser = null, currentGroup = null, cardIndex = 0, choices = [];
    const vibrate = (ms) => { if(navigator.vibrate) navigator.vibrate(ms); }

    // --- NAVIGATION ---
    function navTo(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- AUTH & SYNC ---
    function handleLogin() {
        const u = document.getElementById('username').value.trim();
        const g = document.getElementById('groupName').value.trim();
        if(!u || !g) return alert("Required!");
        currentUser = u; currentGroup = g;
        
        let data = getGroupData();
        if(!data.users.includes(u)) {
            if(data.users.length >= 2) return alert("Room full!");
            data.users.push(u);
            saveGroupData(data);
        }
        checkLobby();
    }
    function getGroupData() { return JSON.parse(localStorage.getItem('spice_' + currentGroup)) || { users: [], selections: {} }; }
    function saveGroupData(data) { localStorage.setItem('spice_' + currentGroup, JSON.stringify(data)); }

    function checkLobby() {
        let data = getGroupData();
        const finished = data.selections[currentUser];
        const partner = data.users.find(u => u !== currentUser);
        const partnerFinished = partner && data.selections[partner];

        let msg = `<div style="font-size:1.2rem; margin-bottom:10px;">Players</div>`;
        msg += `<div style="color:var(--secondary)">‚óè ${currentUser}</div>`;
        msg += partner ? `<div style="color:var(--secondary)">‚óè ${partner}</div>` : `<div style="color:var(--text-muted)">‚óã Waiting...</div>`;
        document.getElementById('status-area').innerHTML = msg;

        if (finished && partnerFinished) {
            calcMatches();
            navTo('bucket');
        } else if (finished) {
            document.getElementById('status-area').innerHTML += `<br><strong>Waiting for partner...</strong>`;
            document.getElementById('start-btn').style.display = 'none';
            navTo('dashboard');
        } else {
            navTo('dashboard');
        }
    }

    // --- GAMEPLAY ENGINE ---
    function startGame() {
        cardIndex = 0; choices = [];
        renderCard();
        navTo('selection');
    }

    function renderCard() {
        const deck = document.getElementById('deck');
        
        if(cardIndex >= CARDS.length) {
            finishGame();
            return;
        }

        // Create fresh card element
        deck.innerHTML = ''; 
        const card = document.createElement('div');
        card.className = 'card';
        card.id = 'active-card';
        card.innerText = CARDS[cardIndex];
        deck.appendChild(card);

        // Initialize Swipe Logic for this specific card
        initSwipe(card);

        // Progress
        const pct = (cardIndex / CARDS.length) * 100;
        document.getElementById('progress').style.width = pct + '%';
    }

    // --- SWIPE PHYSICS LOGIC ---
    function initSwipe(card) {
        let startX = 0, currentX = 0, isDragging = false;

        const start = (x) => {
            isDragging = true;
            startX = x;
            card.style.transition = 'none'; // Remove transition for instant drag
        };

        const move = (x) => {
            if (!isDragging) return;
            currentX = x;
            const deltaX = currentX - startX;
            const rotate = deltaX * 0.1; // 100px move = 10deg rotate
            
            // Apply physics
            card.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;

            // Visual hints could go here (e.g. changing opacity)
        };

        const end = () => {
            if (!isDragging) return;
            isDragging = false;
            const deltaX = currentX - startX;
            const threshold = 100; // How far to swipe to count

            if (Math.abs(deltaX) > threshold) {
                // Completed Swipe
                const liked = deltaX > 0;
                finalizeSwipe(liked, card);
            } else {
                // Snap Back
                card.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                card.style.transform = 'translateX(0) rotate(0)';
            }
        };

        // Touch Events
        card.addEventListener('touchstart', e => start(e.touches[0].clientX));
        card.addEventListener('touchmove', e => move(e.touches[0].clientX));
        card.addEventListener('touchend', end);

        // Mouse Events (for desktop testing)
        card.addEventListener('mousedown', e => start(e.clientX));
        document.addEventListener('mousemove', e => { if(isDragging) move(e.clientX); });
        document.addEventListener('mouseup', end);
    }

    function handleButtonSwipe(liked) {
        const card = document.getElementById('active-card');
        if(!card) return;
        finalizeSwipe(liked, card);
    }

    function finalizeSwipe(liked, card) {
        vibrate(30);
        
        // Add animation class based on direction
        card.style.transition = 'transform 0.5s ease';
        // Need a small timeout to ensure transition takes over if dragging
        requestAnimationFrame(() => {
            card.classList.add(liked ? 'animate-yes' : 'animate-no');
        });

        if(liked) choices.push(cardIndex);

        setTimeout(() => {
            cardIndex++;
            renderCard();
        }, 300);
    }

    function finishGame() {
        let data = getGroupData();
        data.selections[currentUser] = choices;
        saveGroupData(data);
        checkLobby();
    }

    function logout() {
        currentUser = null; currentGroup = null;
        navTo('landing');
    }

    // --- RESULTS ---
    let matches = [];
    function calcMatches() {
        let data = getGroupData();
        let u1 = data.selections[data.users[0]];
        let u2 = data.selections[data.users[1]];
        let intersection = u1.filter(x => u2.includes(x));
        matches = intersection.map(i => CARDS[i]);
        document.getElementById('match-count').innerText = matches.length;
    }

    function pullRandom() {
        vibrate(100);
        const wrapper = document.getElementById('result-wrapper');
        if(matches.length === 0) {
            wrapper.innerHTML = `<div class="result-card">No matches! üßä</div>`;
            return;
        }
        let counter = 0;
        let shuffle = setInterval(() => {
            wrapper.innerHTML = `<div class="result-card" style="transform:scale(1)">${matches[Math.floor(Math.random()*matches.length)]}</div>`;
            counter++;
            if(counter > 15) {
                clearInterval(shuffle);
                showWinner();
            }
        }, 60);
    }

    function showWinner() {
        const winner = matches[Math.floor(Math.random()*matches.length)];
        document.getElementById('result-wrapper').innerHTML = `<div class="result-card" style="border: 3px solid var(--accent)">${winner}</div>`;
        fireConfetti();
        vibrate([100, 50, 100]); 
    }

    function resetGroup() {
        if(confirm("Reset everything?")) {
            localStorage.removeItem('spice_' + currentGroup);
            logout();
        }
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let pieces = [];
        for(let i=0; i<100; i++) {
            pieces.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                color: `hsl(${Math.random()*360}, 100%, 50%)`, size: Math.random() * 8 + 2, speed: Math.random() * 5 + 2
            });
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pieces.forEach(p => {
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
                p.y += p.speed;
                if(p.y > canvas.height) p.y = -10;
            });
            requestAnimationFrame(draw);
        }
        draw();
        setTimeout(() => pieces = [], 4000);
    }
</script>
</body>
</html>